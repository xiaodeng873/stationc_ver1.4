# 批量派藥確認對話框功能

## 功能概述

新增了批量派藥確認對話框,在一鍵派藥和實際寫入資料庫之間增加確認步驟,讓用戶可以按個別服藥時間點進行派藥。

## 主要特點

### 1. 院友資訊與安全警示
- **院友相片**: 顯示院友大頭照(或預設頭像圖標)
- **基本資訊**: 姓名、性別、出生日期、選定日期
- **用藥安全警示**:
  - 🟧 **藥物敏感**(橙色警示框) - 顯示所有敏感藥物
  - 🟥 **不良藥物反應**(紅色警示框) - 顯示所有不良反應
  - 醒目顯示於對話框頂部以防止用藥錯誤

### 2. 時間點總匯卡片
- 自動去重處方的服藥時間點
- 每個時間點顯示為獨立的卡片
- 卡片按時間順序排列

### 3. 正確的統計邏輯
- **處方數量**: 統計該時間點的**不重複處方筆數**
  - 使用 `uniquePrescriptions` Set 去重處方ID
  - 確保同一處方不會重複計算
- **藥物總量**: 按單位分組統計藥物總量
  - 例如: 3 筆處方在 08:00,藥物總量為「15 粒」
  - 支持多種單位同時顯示(粒、包、毫升等)
- **派藥記錄數**: 實際需要派藥的記錄總數(可能大於處方數)

### 4. 彈性選擇派藥
- 可選擇單個或多個時間點
- 提供「全選」/「取消全選」快捷按鈕
- 顯示已選擇的時間點數量和記錄總數

### 5. 批量寫入優化
- 使用單個數據庫事務批量更新
- 相比逐筆更新,顯著提升寫入速度
- 減少數據庫負載和網絡請求

### 6. 即時反映
- 確認派藥後自動關閉對話框
- 立即刷新藥物工作流程表格
- 派藥記錄即時顯示在表格中

## 使用流程

1. 在藥物工作流程頁面點擊「一鍵派藥」按鈕
2. 彈出批量派藥確認對話框
3. **查看院友資訊和用藥安全警示**
4. 查看各個服藥時間點的處方數量和藥物總量
5. 選擇要派藥的時間點(可多選)
6. 點擊「確認派藥」按鈕
7. 系統批量寫入資料庫
8. 對話框自動關閉,表格更新

## 技術優化

### 數據庫性能
- 使用 `upsert` 批量更新代替多次單獨請求
- 單次事務處理所有選定的記錄
- 大幅減少數據庫往返次數

### 用戶體驗
- 視覺化時間點卡片設計
- 清晰的選擇狀態提示
- 處理中的加載狀態顯示
- 即時的成功反饋

### 數據一致性
- 統一的時間戳記錄
- 原子性事務保證數據完整性
- 錯誤處理和回滾機制

## 兼容性

- 不影響即時備藥的現有邏輯
- 即時備藥繼續使用原有的「一鍵全程」功能
- 與現有的檢測項、注射類藥物過濾邏輯完全兼容
- 支持入院狀態自動標記

## 組件位置

- **對話框組件**: `src/components/BatchDispenseConfirmModal.tsx`
- **主要頁面**: `src/pages/MedicationWorkflow.tsx`
- **核心函數**:
  - `handleOneClickDispense()` - 打開確認對話框
  - `handleBatchDispenseConfirm()` - 執行批量派藥

## 未來改進方向

1. 添加派藥歷史記錄查看
2. 支持部分時間點回退功能
3. 添加派藥統計報表
4. 優化大量記錄的顯示性能
