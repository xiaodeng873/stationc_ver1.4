# 批量派藥確認對話框功能 (更新版)

## 功能概述

新增了批量派藥確認對話框,參考「派藥前檢測」模態框的設計風格,在一鍵派藥和實際寫入資料庫之間增加確認步驟,讓用戶可以按個別服藥時間點進行派藥。

## 設計參考

本對話框設計參考「派藥前檢測」模態框 (`InspectionCheckModal`),採用相同的:
- 頂部圖標 + 標題樣式
- 資訊區塊的布局和配色
- 按鈕樣式和排列
- 整體視覺風格

## 主要特點

### 1. 院友資訊與安全警示

**院友資訊區**(灰色背景):
- **院友相片**: 顯示院友大頭照(或預設頭像圖標)
- **基本資訊**: 姓名、性別、出生日期

**用藥安全警示**:
- 🟧 **藥物敏感**(橙色警示框) - 顯示所有敏感藥物項目
- 🟥 **不良藥物反應**(紅色警示框) - 顯示所有不良反應項目
- 醒目顯示於院友資訊區域

### 2. 正確的統計邏輯

**只包含在服處方**:
- 僅統計 `status = 'active'` 的處方
- **不包含**待變更 (`pending_change`) 或停用 (`inactive`) 的處方
- 確保統計數據準確反映當前有效處方

**處方數量統計**:
- 使用 `uniquePrescriptions: Set<string>` 追蹤不重複的處方ID
- 每個時間點正確顯示**處方數量**(去重後的處方筆數)

**藥物總量統計**:
- 按單位分組統計(粒、包、毫升等)
- 累加所有記錄的劑量
- 範例: 3筆處方在 08:00,每筆5粒 → 顯示「處方數量: 3筆」「藥物總量: 15粒」

### 3. 檢測項支援

**包含有檢測項要求的處方**:
- 對話框中會顯示「含檢測項要求」標識
- 自動執行檢測邏輯

**自動化檢測處理**:
- **檢測合格**: 正常派藥,標記為「完成」
- **檢測不合格**: 標記為「暫停」,失敗原因「檢測項條件不符」
- **入院中**: 標記為「入院」失敗原因

**無需手動介入**:
- 系統自動調用 `checkPrescriptionInspectionRules` 執行檢測
- 根據檢測結果自動寫入對應狀態
- 用戶只需選擇時間點,無需手動處理檢測項

### 4. 時間點卡片顯示

- 自動去重處方的服藥時間點
- 每個時間點顯示為獨立的卡片
- 顯示處方數量、藥物總量
- 標識是否含檢測項要求
- 卡片按時間順序排列

### 5. 彈性選擇派藥

- 可選擇單個或多個時間點
- 提供「全選」/「取消全選」快捷按鈕
- 顯示已選擇的時間點數量和記錄總數

### 6. 並行處理優化

- 使用 `Promise.allSettled` 並行處理所有派藥操作
- 相比逐筆處理大幅提升速度
- 每筆記錄獨立處理,互不影響

### 7. 即時反映

- 確認派藥後自動關閉對話框
- 系統自動處理所有檢測項邏輯
- 派藥記錄即時顯示在表格中

## 使用流程

1. 在藥物工作流程頁面點擊「一鍵派藥」按鈕
2. 彈出批量派藥確認對話框
3. **查看院友資訊和用藥安全警示**
4. 查看各個服藥時間點的處方數量和藥物總量
5. 注意標有「含檢測項要求」的時間點
6. 選擇要派藥的時間點(可多選)
7. 點擊「確認派藥」按鈕
8. 系統自動處理:
   - 無檢測項 → 直接派藥
   - 有檢測項 → 自動檢測 → 合格派藥 / 不合格暫停
   - 入院中 → 標記入院
9. 對話框自動關閉,表格更新

## 技術實現

### 過濾邏輯
```typescript
// 只包含在服處方
prescription.status === 'active'

// 排除注射類藥物
prescription.administration_route !== '注射'

// 包含所有待派藥的記錄(包括有檢測項要求的)
r.dispensing_status === 'pending' && r.verification_status === 'completed'
```

### 檢測項自動處理
```typescript
if (hasInspectionRules) {
  const checkResult = await checkPrescriptionInspectionRules(...);

  if (checkResult.canDispense) {
    // 檢測合格：正常派藥
    await dispenseMedication(..., checkResult);
  } else {
    // 檢測不合格：標記為暫停
    await dispenseMedication(..., '暫停', '檢測項條件不符', checkResult);
  }
}
```

### 結果統計
- **成功**: 正常派藥完成
- **暫停**: 檢測不合格
- **入院**: 院友入院中
- **失敗**: 系統錯誤

## 兼容性

- 不影響即時備藥的現有邏輯
- 即時備藥繼續使用原有的「一鍵全程」功能
- 與現有的檢測項邏輯完全兼容
- 支持入院狀態自動標記
- 處理待變更和停用處方的過濾

## 組件位置

- **對話框組件**: `src/components/BatchDispenseConfirmModal.tsx`
- **主要頁面**: `src/pages/MedicationWorkflow.tsx`
- **核心函數**:
  - `handleOneClickDispense()` - 打開確認對話框
  - `handleBatchDispenseConfirm()` - 執行批量派藥(含檢測項處理)

## 設計改進重點

1. ✅ 參考「派藥前檢測」模態框設計風格
2. ✅ 添加院友相片和個人資訊
3. ✅ 顯示藥物敏感和不良藥物反應警示
4. ✅ 修正統計邏輯:只包含在服處方
5. ✅ 支持檢測項要求的處方
6. ✅ 自動執行檢測邏輯並處理結果
7. ✅ 檢測不合格標記為「暫停」

## 未來改進方向

1. 添加派藥歷史記錄查看
2. 支持部分時間點回退功能
3. 添加派藥統計報表
4. 優化大量記錄的顯示性能
5. 支持批量檢測項輸入界面
