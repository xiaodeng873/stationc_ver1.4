# 工作流程記錄生成邏輯更新

## 更新日期
2025年11月9日

## 更新內容

### 核心變更
Edge Function `generate-daily-medication-workflow` 現在支援為**所有狀態的處方**（包含在服和停用）生成工作流程記錄，只要目標日期在處方有效期內。

### 修改前的行為
- 只為「在服」狀態（`status = 'active'`）的處方生成記錄
- 停用處方（`status = 'inactive'`）完全被忽略
- 無法為已過期處方補充歷史記錄

### 修改後的行為
- 為**所有處方**生成記錄，不限狀態
- 條件：目標日期必須在處方有效期內（`start_date` ≤ `目標日期` ≤ `end_date`）
- 可以為已停用的處方補充其有效期內的歷史記錄

## 使用場景

### 場景1：補充歷史記錄
**情況：** 11月2-8日的 Ciprofloxacin 處方已停用，但需要補充執核派記錄

**操作步驟：**
1. 進入「藥物工作流程」頁面
2. 選擇該院友
3. 使用「批量生成記錄」功能，選擇11月2日至11月8日
4. 系統會檢查處方是否在這些日期範圍內有效
5. 為有效期內的日期生成工作流程記錄
6. 補充執核派操作
7. 匯出 Excel 記錄

### 場景2：處方到期但仍需查看記錄
**情況：** 處方結束日期已過，但仍需查看和匯出該處方的歷史執核派記錄

**操作步驟：**
1. 進入「藥物工作流程」頁面
2. 選擇對應週次（包含處方有效期的日期）
3. 系統會自動顯示該處方的已有記錄
4. 可以查看、編輯、匯出記錄

## 技術細節

### Edge Function 變更

**修改的查詢邏輯：**
```typescript
// 修改前：只查詢在服處方
.eq('status', 'active')

// 修改後：查詢所有處方
// 移除了 status 篩選條件
```

**增強的日期驗證：**
```typescript
// 檢查開始日期
if (targetDateStr < startDateStr) {
  continue; // 跳過尚未開始的處方
}

// 檢查結束日期（重新啟用）
if (endDateStr && targetDateStr > endDateStr) {
  continue; // 跳過已超出有效期的處方
}
```

### 診斷工具更新
`src/utils/diagnoseTool.ts` 已更新，支援新的邏輯：
- 統一查詢所有處方（不分狀態）
- 更新說明文字，反映新的生成規則
- 改進預期記錄數計算邏輯

## 注意事項

### ⚠️ 重要提醒
1. **處方有效期必須正確設定**
   - `start_date` 必須是處方開始服用的日期
   - `end_date` 必須是處方最後服用的日期（如果有停用日期）
   - 如果日期設定錯誤，可能無法正確生成記錄

2. **不會自動生成記錄**
   - 系統不會在處方創建時自動生成工作流程記錄
   - 必須手動在「藥物工作流程」頁面點擊「生成記錄」
   - 建議定期生成未來幾天的記錄

3. **停用處方的工作流程記錄**
   - 停用處方的工作流程記錄會繼續顯示在表格中
   - 可以繼續編輯和補充這些記錄
   - 匯出 Excel 時會包含停用處方的記錄

## 驗證方法

### 測試步驟
1. 找一個已停用的處方，記下其 `start_date` 和 `end_date`
2. 在「藥物工作流程」頁面，選擇該處方有效期內的某一天
3. 點擊「生成當日記錄」或「批量生成記錄」
4. 檢查是否成功生成記錄
5. 確認可以正常補充執核派操作
6. 驗證可以匯出 Excel

### 使用診斷工具
在瀏覽器控制台執行：
```javascript
import { diagnoseWorkflowDisplayIssue } from './src/utils/diagnoseTool';

// 診斷特定院友的特定日期範圍
diagnoseWorkflowDisplayIssue(院友ID, '2025-11-02', '2025-11-08');
```

## 相關文件
- Edge Function: `supabase/functions/generate-daily-medication-workflow/index.ts`
- 診斷工具: `src/utils/diagnoseTool.ts`
- 工作流程生成器: `src/utils/workflowGenerator.ts`

## 常見問題

**Q: 為什麼我的停用處方沒有生成記錄？**
A: 檢查目標日期是否在處方的 `start_date` 和 `end_date` 範圍內。如果超出範圍，系統不會生成記錄。

**Q: 可以為很久以前的處方生成記錄嗎？**
A: 可以！只要該日期在處方有效期內，不論多久以前都可以生成。

**Q: 生成的記錄會覆蓋已有的記錄嗎？**
A: 不會。系統會先檢查記錄是否已存在，已存在的記錄會被跳過，不會重複生成。

**Q: 如何一次性為整週生成記錄？**
A: 在「藥物工作流程」頁面，使用「批量生成記錄」功能，選擇週一到週日的日期範圍。
