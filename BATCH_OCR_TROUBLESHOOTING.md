# 批量健康記錄OCR功能故障排除指南

## 常見錯誤及解決方案

### 1. "Edge Function returned a non-2xx status code"

**可能原因：**
- Google Gemini API配額用盡
- API Key無效或過期
- 網絡連接問題
- Prompt格式導致AI無法解析

**解決方法：**

#### A. 檢查Gemini API配額
1. 訪問 [Google AI Studio](https://aistudio.google.com/)
2. 檢查API配額使用情況
3. 如配額用盡，等待重置或升級計劃

#### B. 驗證API Key
1. 檢查 `supabase/functions/gemini-extract/index.ts` 中的 `GOOGLE_GEMINI_API_KEY`
2. 確保API Key有效且未過期
3. 測試API Key：
```bash
curl "https://generativelanguage.googleapis.com/v1beta/models?key=YOUR_API_KEY"
```

#### C. 調整Prompt格式
如果API返回格式錯誤，嘗試修改Prompt：

**優化建議：**
- 明確指定返回JSON格式
- 簡化提取規則
- 提供清晰的示例

**示例Prompt（簡化版）：**
```
從圖片中提取健康記錄，返回JSON：
{
  "記錄日期": "2025-01-15",
  "records": [
    {
      "床號": "A01",
      "院友姓名": "陳大文",
      "記錄時間": "07:00",
      "記錄類型": "生命表徵",
      "血壓收縮壓": 120,
      "血壓舒張壓": 80,
      "脈搏": 72,
      "體溫": 36.5,
      "血含氧量": 98
    }
  ]
}

時間格式：7A→07:00, 12N→12:00, 4P→16:00
```

### 2. "AI返回的數據格式不正確"

**原因：**
AI返回的JSON結構與預期不符

**解決方法：**
1. 檢查上傳的圖片是否清晰
2. 確保圖片包含表格標題（日期）
3. 使用更清晰的手寫或打印記錄
4. 調整Prompt以更明確地指定格式要求

### 3. "無法匹配院友"

**原因：**
系統無法根據床號或姓名找到對應院友

**解決方法：**
1. 確保院友記錄已在系統中建立
2. 檢查床號拼寫是否正確（如：A01 vs A1）
3. 檢查姓名是否完整
4. 在結果表格中手動修正床號或姓名

### 4. 圖片上傳失敗

**原因：**
- 圖片格式不支援
- 圖片檔案過大（>5MB）
- 網絡問題

**解決方法：**
1. 使用支援的格式：JPG、PNG、WEBP
2. 壓縮大型圖片
3. 檢查網絡連接

## 最佳實踐

### 拍攝/掃描建議
1. **光線充足**：確保記錄表清晰可見
2. **避免反光**：使用柔和光線，避免強光反射
3. **正面拍攝**：保持相機與紙張平行
4. **清晰對焦**：確保文字清晰可辨
5. **完整內容**：包含表格標題和所有記錄

### Prompt優化技巧
1. **明確格式**：清楚說明返回的JSON結構
2. **提供示例**：包含完整的示例輸出
3. **時間規則**：明確時間標記的轉換規則
4. **特殊處理**：說明如何處理缺失或無法識別的數據

### 批量上傳策略
1. **分批處理**：建議每次上傳2-5張圖片
2. **相似內容**：同一批次使用相同格式的記錄表
3. **逐步驗證**：先處理一張，確認無誤後再批量處理

## 檢查清單

上傳前請確認：
- [ ] 圖片清晰可讀
- [ ] 包含完整日期
- [ ] 院友床號和姓名清晰
- [ ] Prompt已根據記錄表格式調整
- [ ] 網絡連接正常
- [ ] API配額充足

## 技術支援

如問題持續存在：
1. 查看瀏覽器控制台錯誤訊息
2. 檢查Supabase Edge Function日誌
3. 聯繫技術支援並提供：
   - 錯誤截圖
   - 使用的Prompt內容
   - 上傳圖片樣本（如可能）

## 進階調試

### 查看詳細錯誤
打開瀏覽器開發者工具（F12）：
1. 切換到 Console 標籤
2. 查找 `[BatchOCR]` 開頭的日誌
3. 記錄完整錯誤信息

### 測試單張圖片
使用「處方管理」頁面的單張OCR功能測試：
1. 上傳單張圖片
2. 查看是否能成功識別
3. 如果成功，問題可能在批量處理邏輯
4. 如果失敗，問題在OCR或API層面

### Edge Function日誌
在Supabase Dashboard查看：
1. 進入 Functions 頁面
2. 選擇 `gemini-extract`
3. 查看 Logs 標籤
4. 檢查詳細錯誤信息
