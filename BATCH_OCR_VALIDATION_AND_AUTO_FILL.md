# 批量健康記錄OCR - 儲存校驗與自動填充功能

## 更新日期
2025-12-15

## 功能概述
為批量健康記錄OCR功能添加完整的儲存前校驗、自動填充隨機值、單行儲存等功能。

## 新增功能

### 1. 儲存前校驗
每筆記錄在儲存前都會進行以下校驗：

- ✅ **必須選擇院友** - 院友id不能為空
- ✅ **必須選擇日期** - 記錄日期不能為空
- ✅ **必須選擇時間** - 記錄時間不能為空
- ✅ **必須選擇記錄類型** - 記錄類型不能為空
- ✅ **至少有一個監測數值**：
  - 血壓（收縮壓 + 舒張壓）
  - 或 血糖
  - 或 體重

### 2. 自動填充隨機值
當記錄缺少以下生命體徵數值時，系統會自動生成合理範圍的隨機值：

- **體溫**：36.0-37.5°C（一位小數）
- **血含氧量**：95-99%（整數）
- **呼吸頻率**：16-23次/分（整數）

> **注意**：OCR識別到的數值（血壓、血糖、體重）不會被自動填充，保持原始識別結果或用戶手動輸入的值。

### 3. 單行儲存功能
每條記錄旁邊都有獨立的儲存按鈕（綠色圖標）：

- 點擊後立即校驗該記錄
- 自動填充隨機值（體溫、血氧、呼吸）
- 儲存成功後，該記錄會從表格中移除
- 顯示儲存成功或失敗的提示訊息

### 4. 批量儲存優化
批量儲存按鈕會：

- 校驗所有記錄的完整性
- 顯示前5筆錯誤記錄的詳細錯誤訊息
- 提示總共有多少筆錯誤記錄
- 詢問是否只儲存有效記錄
- 儲存完成後顯示：成功筆數、失敗筆數、跳過筆數
- 成功儲存的記錄會從表格中移除

## 錯誤提示範例

### 單行儲存錯誤
```
儲存失敗：
必須選擇院友
至少需要一個監測數值（血壓、血糖或體重）
```

### 批量儲存錯誤
```
發現 3 筆記錄有錯誤：

A01 陳大文: 必須選擇日期, 必須選擇時間
B02 李小明: 至少需要一個監測數值（血壓、血糖或體重）
C03 王美麗: 必須選擇院友

是否只儲存 7 筆有效記錄？
```

## 使用流程

1. **上傳圖片** - 選擇一張或多張手寫健康記錄表
2. **開始識別** - 點擊「開始批量識別」按鈕
3. **檢查結果** - 查看識別結果表格
4. **編輯修正** - 手動修正任何錯誤的欄位
5. **單行儲存** - 點擊綠色儲存按鈕儲存單筆記錄
   - 或 **批量儲存** - 點擊「批量儲存」按鈕一次儲存所有記錄
6. **自動處理** - 系統自動填充缺失的生命體徵數值
7. **移除記錄** - 成功儲存的記錄會從表格中移除

## 技術實現

### 校驗函數
```typescript
const validateRecord = (record: ParsedHealthRecord): { valid: boolean; errors: string[] } => {
  const errors: string[] = [];

  // 檢查必填欄位
  if (!record.院友id) errors.push('必須選擇院友');
  if (!record.記錄日期) errors.push('必須選擇日期');
  if (!record.記錄時間) errors.push('必須選擇時間');
  if (!record.記錄類型) errors.push('必須選擇記錄類型');

  // 檢查至少有一個監測數值
  const hasBloodPressure = record.血壓收縮壓 && record.血壓舒張壓;
  const hasBloodSugar = record.血糖值;
  const hasWeight = record.體重;
  const hasRequiredValue = hasBloodPressure || hasBloodSugar || hasWeight;

  if (!hasRequiredValue) {
    errors.push('至少需要一個監測數值（血壓、血糖或體重）');
  }

  return { valid: errors.length === 0, errors };
};
```

### 隨機值生成函數
```typescript
const generateRandomVitals = () => {
  return {
    體溫: Number((36.0 + Math.random() * 1.5).toFixed(1)), // 36.0-37.5°C
    血含氧量: Math.floor(95 + Math.random() * 5), // 95-99%
    呼吸頻率: Math.floor(16 + Math.random() * 8) // 16-23次/分
  };
};
```

### 自動填充函數
```typescript
const fillRandomVitals = (record: ParsedHealthRecord): ParsedHealthRecord => {
  const randomVitals = generateRandomVitals();
  return {
    ...record,
    體溫: record.體溫 || randomVitals.體溫,
    血含氧量: record.血含氧量 || randomVitals.血含氧量,
    呼吸頻率: record.呼吸頻率 || randomVitals.呼吸頻率
  };
};
```

## UI改進

1. **操作按鈕** - 每行記錄現在有兩個按鈕：
   - 綠色儲存圖標（Save）- 單行儲存
   - 紅色刪除圖標（Trash2）- 刪除記錄

2. **使用說明** - 更新了說明文字，新增：
   - 儲存前校驗規則說明
   - 自動補充功能說明
   - 單行儲存和批量儲存的區別

3. **狀態指示** - 儲存過程中按鈕會禁用，防止重複操作

## 測試建議

1. **測試缺少院友的記錄** - 確認會顯示錯誤並阻止儲存
2. **測試缺少監測數值的記錄** - 確認會顯示錯誤
3. **測試只有血糖的記錄** - 確認可以正常儲存
4. **測試只有血壓的記錄** - 確認可以正常儲存
5. **測試只有體重的記錄** - 確認可以正常儲存
6. **測試自動填充** - 確認體溫、血氧、呼吸會自動生成
7. **測試單行儲存** - 確認記錄會從表格移除
8. **測試批量儲存** - 確認只儲存有效記錄

## 注意事項

1. **不影響現有功能** - 所有現有的OCR識別、編輯、匹配功能都保持不變
2. **數據安全** - 儲存失敗不會影響原始表格數據
3. **用戶體驗** - 清晰的錯誤提示幫助用戶快速定位問題
4. **靈活性** - 用戶可以選擇單行儲存或批量儲存

## 相關文件

- `/src/components/BatchHealthRecordOCRModal.tsx` - 主要功能實現
- `/src/utils/ocrProcessor.ts` - OCR處理工具
- `/src/pages/CareRecords.tsx` - 調用批量OCR模態框的頁面
