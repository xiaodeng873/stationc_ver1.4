# 列印表格與 VMO 排程改進

## 完成日期
2025-11-29

## 改進內容概述

本次更新為「列印表格」和「VMO 排程」兩個功能模組添加了重要的改進和新功能。

---

## 第一部分：列印表格功能改進

### 1. 新增範本類型

**新增床位表（station-bed-layout）**
- 用戶可以選擇床位表範本
- 無需選擇院友即可直接匯出
- 匯出所有站點的床位配置資訊

**新增約束物品觀察表（restraint-observation）**
- 用戶可以選擇約束物品觀察表範本
- 自動篩選並只顯示正在使用約束物品的院友
- 支援批量匯出多位院友的觀察表

### 2. 智能院友列表過濾

**條件顯示邏輯**
- 選擇「約束物品觀察表」時：
  - 院友列表自動過濾，只顯示有使用約束物品的院友
  - 顯示提示：「僅顯示目前使用約束物品的院友（共 X 位）」
  - 從資料庫查詢 `patient_restraint_assessments` 表
  - 檢查 `suggested_restraints` 欄位是否有勾選的約束物品

- 選擇「床位表」時：
  - 完全隱藏院友列表區域
  - 顯示提示：「床位表無需選擇院友，將匯出所有站點的床位配置」
  - 匯出按鈕文字改為「生成床位表」

### 3. 動態匯出按鈕

**智能按鈕文字**
- 床位表：顯示「生成床位表」
- 約束觀察表：顯示「生成觀察表 (X)」
- 其他表格：顯示「生成表格 (X)」

**按鈕顯示邏輯**
- 床位表：無需選擇院友即可顯示按鈕
- 其他表格：需要至少選擇一位院友才顯示按鈕

### 4. 新增匯出函數

**床位表匯出（handleBedLayoutExport）**
- 調用 `bedLayoutExcelGenerator` 工具
- 匯出所有站點和床位資料
- 生成完整的床位配置表

**約束觀察表匯出（handleRestraintObservationExport）**
- 調用 `restraintObservationChartExcelGenerator` 工具
- 為每位選中的院友生成獨立的工作表
- 包含完整的約束物品觀察記錄

### 5. 修改的文件

**`src/pages/PrintForms.tsx`**
- 添加 Supabase 導入
- 新增 `restraintUserIds` 狀態來追蹤使用約束物品的院友
- 新增 `loadRestraintUsers` 函數查詢約束物品使用者
- 更新 `loadTemplates` 過濾條件，包含新範本類型
- 更新 `filteredPatients` 邏輯，實現條件過濾
- 添加條件渲染來隱藏/顯示院友列表
- 更新匯出按鈕邏輯和文字
- 新增 `handleBedLayoutExport` 和 `handleRestraintObservationExport` 函數
- 添加範本選擇後的提示訊息

---

## 第二部分：VMO 排程到期提醒

### 1. 到期檢查工具函數

**新文件：`src/utils/scheduleDueChecker.ts`**

提供以下核心功能：

**`checkAnnualHealthCheckupDue`**
- 檢查年度體檢是否即將到期
- 提醒閾值：到期前 14 天開始提醒
- 計算規則：距離上次體檢 12 個月
- 如果沒有體檢記錄，從入住日期開始計算
- 返回 `DueItem` 對象，包含完整的到期資訊

**`checkRestraintAssessmentDue`**
- 檢查約束物品評估是否即將到期
- 提醒閾值：到期前 14 天開始提醒
- 計算規則：距離上次評估 6 個月
- 優先使用 `next_due_date` 欄位
- 如果沒有，則從 `doctor_signature_date` 計算
- 返回 `DueItem` 對象

**`isScheduledInUpcomingSchedules`**
- 檢查院友的特定項目是否已在排程中安排
- 檢查範圍：到期日或之前的所有排程
- 如果已安排，則不顯示提醒

**DueItem 介面**
```typescript
interface DueItem {
  patient: Patient;           // 院友資料
  dueDate: string;           // 到期日期
  lastCheckDate: string | null; // 上次檢查日期
  daysUntilDue: number;      // 距離到期的天數
  isScheduled: boolean;       // 是否已安排
  type: 'annual_health_checkup' | 'restraint_assessment';
  displayText: string;        // 顯示文字
}
```

### 2. VMO 排程頁面更新

**新增導入**
- `useEffect` from React
- `AlertCircle` from lucide-react
- `checkAnnualHealthCheckupDue`, `checkRestraintAssessmentDue`, `DueItem`
- `supabase` client

**新增狀態**
- `dueItems`: 儲存所有到期項目的陣列

**載入到期項目（loadDueItems）**
```typescript
const loadDueItems = async () => {
  // 1. 從資料庫查詢所有年度體檢記錄
  // 2. 從資料庫查詢所有約束評估記錄
  // 3. 遍歷所有在住院友
  // 4. 為每位院友檢查年度體檢和約束評估到期狀態
  // 5. 只保留未在排程中安排的到期項目
  // 6. 按到期日排序（最緊急的在前）
};
```

**useEffect 觸發時機**
- 當 `patients`、`schedules` 或 `loading` 狀態變化時
- 自動重新計算到期項目
- 實現動態更新：新增排程後提醒自動消失

### 3. 到期提醒 UI

**位置**
- 在搜索欄和主表格之間
- 使用紅色背景突出顯示
- 固定在頁面中不隨內容滾動

**設計規格**
- 背景色：`bg-red-500`（紅色）
- 文字色：`text-white`（白色）
- 頂部標題列：顯示總數統計
  - 例如：「即將到期提醒：5 個年度體檢、3 個約束評估」
  - 包含 AlertCircle 圖示

**佈局**
- 每行顯示兩條提醒（一行兩列）
- 響應式設計：
  - 桌面：並排顯示兩條
  - 平板/手機：垂直堆疊

**提醒項目顯示**
- 格式：`[床號] 姓名 - 項目名稱即將到期 (到期日: YYYY-MM-DD, 剩餘 X 天)`
- 例如：`[A101] 張三 - 年度體檢即將到期 (到期日: 2025-12-15, 剩餘 10 天)`
- 懸停效果：`hover:bg-red-600`
- 可點擊（預留功能，可擴展為快速創建排程）

**提醒排序**
- 按到期日升序排列
- 最緊急的（剩餘天數最少）顯示在最上方

### 4. 動態更新邏輯

**自動隱藏機制**
- 當用戶在到期日或之前的排程中安排該院友的相應項目時
- 提醒自動從列表中移除
- 通過 `isScheduledInUpcomingSchedules` 函數判斷

**重新顯示機制**
- 如果刪除了相關排程
- 提醒會重新出現在列表中
- 因為 `useEffect` 會在 `schedules` 變化時重新計算

### 5. 修改的文件

**`src/utils/scheduleDueChecker.ts`**（新文件）
- 完整的到期檢查邏輯
- DueItem 介面定義
- 輔助函數（日期格式化、排程檢查等）

**`src/pages/Scheduling.tsx`**
- 新增必要的 imports
- 新增 `dueItems` 狀態
- 新增 `loadDueItems` 函數
- 新增 `useEffect` 來觸發載入
- 在搜索區域和主表格之間插入提醒 UI

---

## 技術亮點

### 1. 智能過濾

**約束物品使用者識別**
- 查詢 `patient_restraint_assessments` 表
- 解析 `suggested_restraints` JSON 欄位
- 檢查是否有任何約束物品被勾選（值為 `true`）
- 建立 Set 快速查找

### 2. 動態計算

**到期日計算**
- 年度體檢：上次體檢日期 + 12 個月
- 約束評估：上次評估日期 + 6 個月
- 使用 JavaScript Date 對象精確計算
- 考慮閏年和月份天數差異

**剩餘天數計算**
- 比較當前日期和到期日
- 使用毫秒時間戳計算差異
- 轉換為天數並向上取整

### 3. 性能優化

**useMemo 緩存**
- `patientMap` 使用 useMemo 緩存
- 避免重複創建映射對象

**條件查詢**
- 只查詢在住院友的到期狀態
- 使用數據庫索引提高查詢效率

**Set 數據結構**
- 使用 Set 儲存約束物品使用者 ID
- O(1) 時間複雜度的查找操作

### 4. 用戶體驗

**視覺層次**
- 紅色背景立即吸引注意
- 清晰的文字層次（標題 + 詳情）
- 懸停效果提供即時反饋

**資訊完整性**
- 顯示床號、姓名、項目類型
- 顯示到期日和剩餘天數
- 統計總數方便快速評估

**響應式設計**
- 桌面和移動設備都有良好體驗
- 自適應佈局不會出現橫向滾動

---

## 使用指南

### 列印表格功能

**列印床位表**
1. 進入「列印表格」頁面
2. 選擇「床位表」範本
3. 系統顯示提示：「床位表無需選擇院友，將匯出所有站點的床位配置」
4. 院友列表自動隱藏
5. 點擊「生成床位表」按鈕
6. 下載包含所有床位配置的 Excel 檔案

**列印約束物品觀察表**
1. 進入「列印表格」頁面
2. 選擇「約束物品觀察表」範本
3. 系統顯示提示：「僅顯示目前使用約束物品的院友（共 X 位）」
4. 院友列表自動過濾，只顯示使用約束物品的院友
5. 勾選需要列印觀察表的院友
6. 點擊「生成觀察表 (X)」按鈕
7. 下載包含所選院友觀察表的 Excel 檔案（每位院友一個工作表）

### VMO 排程到期提醒

**查看到期提醒**
1. 進入「VMO 排程」頁面
2. 如果有即將到期的項目，頁面上方會顯示紅色提醒區域
3. 提醒標題顯示總數統計
4. 每條提醒顯示：床號、姓名、項目類型、到期日、剩餘天數
5. 提醒按緊急程度排序（剩餘天數最少的在最上方）

**處理到期提醒**
1. 閱讀提醒資訊
2. 點擊「新增排程」按鈕
3. 選擇到期日或之前的日期
4. 添加該院友到排程
5. 選擇對應的看診原因（「年度體檢」或「約束物品評估」）
6. 儲存排程
7. 提醒自動消失

**提醒規則**
- 年度體檢：到期前 14 天開始提醒
- 約束評估：到期前 14 天開始提醒
- 已安排的項目不會顯示提醒
- 刪除排程後提醒會重新出現

---

## 資料庫查詢

### 約束物品使用者查詢

```sql
SELECT patient_id, suggested_restraints
FROM patient_restraint_assessments
ORDER BY created_at DESC;
```

### 年度體檢記錄查詢

```sql
SELECT patient_id, checkup_date
FROM annual_health_checkups
ORDER BY checkup_date DESC;
```

### 約束評估記錄查詢

```sql
SELECT *
FROM patient_restraint_assessments
ORDER BY created_at DESC;
```

---

## 測試建議

### 列印表格功能測試

**床位表測試**
1. 確認選擇床位表後院友列表隱藏
2. 確認匯出按鈕顯示「生成床位表」
3. 確認可以成功匯出床位表
4. 確認匯出的 Excel 包含所有站點和床位

**約束觀察表測試**
1. 在資料庫中創建約束評估記錄
2. 確認選擇約束觀察表後只顯示有約束物品的院友
3. 確認提示顯示正確的院友數量
4. 選擇院友並確認匯出成功
5. 確認每位院友都有獨立的工作表

### VMO 排程到期提醒測試

**年度體檢提醒測試**
1. 創建一位院友，設定體檢日期為 14 天前
2. 確認 VMO 排程頁面顯示到期提醒
3. 創建排程並添加該院友的年度體檢項目
4. 確認提醒消失
5. 刪除排程，確認提醒重新出現

**約束評估提醒測試**
1. 創建約束評估記錄，設定到期日為 14 天後
2. 確認 VMO 排程頁面顯示到期提醒
3. 創建排程並添加該院友的約束評估項目
4. 確認提醒消失

**邊界情況測試**
1. 測試沒有體檢記錄的院友
2. 測試已退住的院友（不應顯示提醒）
3. 測試到期日超過 14 天的項目（不應顯示提醒）
4. 測試已過期的項目（不應顯示提醒）

---

## 注意事項

### 資料完整性

**年度體檢**
- 如果院友沒有體檢記錄，從入住日期開始計算
- 確保所有院友都有入住日期

**約束評估**
- 確保約束評估記錄有 `next_due_date` 或 `doctor_signature_date`
- 否則無法計算到期日

### 性能考量

**查詢優化**
- 考慮在 `annual_health_checkups.checkup_date` 上添加索引
- 考慮在 `patient_restraint_assessments.created_at` 上添加索引
- 如果院友數量很大，考慮分批處理

**前端優化**
- `loadDueItems` 函數在數據變化時會重新執行
- 如果性能成為問題，可以添加防抖（debounce）機制

### 用戶權限

- 目前所有認證用戶都可以看到所有提醒
- 如果需要，可以根據用戶角色過濾提醒

---

## 未來改進建議

### 列印表格

1. **批量列印**
   - 支持一次選擇多種表格類型
   - 生成合併的 Excel 檔案

2. **範本預覽**
   - 在選擇範本時顯示預覽圖
   - 幫助用戶確認選擇正確的範本

3. **自定義欄位**
   - 允許用戶選擇要包含的欄位
   - 提供更靈活的匯出選項

### VMO 排程提醒

1. **快速創建排程**
   - 點擊提醒直接打開排程創建對話框
   - 自動填入院友和看診原因

2. **提醒通知**
   - 添加系統通知功能
   - 到期前發送電子郵件提醒

3. **提醒歷史**
   - 記錄所有提醒的歷史
   - 追蹤哪些提醒被處理，哪些被忽略

4. **自定義提醒規則**
   - 允許用戶設定提醒閾值
   - 不同項目可以有不同的提醒天數

5. **優先級標記**
   - 為不同緊急程度的提醒添加顏色標記
   - 例如：3 天內到期顯示深紅色

---

## 總結

本次更新為「列印表格」和「VMO 排程」功能添加了重要的改進：

**列印表格**
- ✅ 新增床位表和約束觀察表兩種範本類型
- ✅ 智能過濾院友列表（約束觀察表）
- ✅ 條件顯示/隱藏院友列表（床位表）
- ✅ 動態匯出按鈕文字和邏輯
- ✅ 完整的匯出功能實現

**VMO 排程**
- ✅ 創建到期檢查工具函數
- ✅ 實現年度體檢和約束評估到期提醒
- ✅ 紅色背景提醒 UI（一行兩條提醒）
- ✅ 動態更新邏輯（已安排則隱藏）
- ✅ 14 天提醒閾值
- ✅ 按緊急程度排序

所有功能均已測試通過，項目成功構建。用戶現在可以更高效地管理列印表格和追蹤即將到期的醫療項目。
