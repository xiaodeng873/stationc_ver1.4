# 藥物工作流程顯示修復 - 測試指南

## 快速測試步驟

### 測試 1: 基本生成功能

1. **打開藥物工作流程頁面**
   - 導航到"藥物工作流程"頁面

2. **選擇院友**
   - 在上方下拉選單中選擇一個有在服處方的院友（例如：院友ID 19）

3. **查看初始狀態**
   - 檢查表格是否顯示該院友的在服處方
   - 注意每個時間槽的初始狀態（可能顯示"無記錄"）

4. **點擊生成按鈕**
   - 點擊右上角的"生成本週工作流程"按鈕
   - 應該看到按鈕變為"生成中..."並顯示旋轉動畫

5. **等待生成完成**
   - 生成過程大約需要 5-10 秒
   - 觀察瀏覽器控制台的日誌輸出

6. **驗證結果**
   - 應該彈出成功提示：`✅ 成功生成並載入 XX 筆工作流程記錄！`
   - 表格中每個處方的時間槽應該立即顯示三個按鈕：
     - 執藥 (preparation)
     - 核藥 (verification)
     - 派藥 (dispensing)
   - 所有按鈕應該都是藍色（pending 狀態）

### 測試 2: 刷新功能

1. **點擊刷新按鈕**
   - 點擊右上角的"刷新"按鈕
   - 應該看到按鈕圖標開始旋轉

2. **驗證刷新結果**
   - 數據應該重新載入
   - 工作流程按鈕應該保持顯示
   - 檢查控制台日誌是否顯示：`✅ 刷新成功: 載入 XX 筆記錄`

### 測試 3: 切換院友

1. **選擇另一個院友**
   - 在下拉選單中選擇不同的院友

2. **驗證數據更新**
   - 表格應該顯示新院友的處方
   - 工作流程記錄應該對應新院友

3. **再次生成**
   - 為新院友生成工作流程
   - 驗證是否正確顯示

### 測試 4: 執行工作流程

1. **執藥操作**
   - 點擊任意一個"執藥"按鈕
   - 按鈕應該變為綠色並顯示完成標記

2. **核藥操作**
   - 點擊對應的"核藥"按鈕
   - 按鈕應該變為綠色

3. **派藥操作**
   - 點擊對應的"派藥"按鈕
   - 按鈕應該變為綠色

## 控制台日誌檢查

打開瀏覽器開發者工具（F12），在控制台中查看以下關鍵日誌：

### 生成工作流程時應該看到：

```
=== 手動生成本週工作流程 ===
生成前記錄數: 0

====== 批量生成工作流程記錄 ======
日期範圍: 2025-11-02 至 2025-11-08
院友ID: 19

[1] 正在生成 2025-11-02 的記錄...
✓ 2025-11-02: 成功生成 1 筆記錄
...

====== 批量生成完成 ======
成功生成記錄總數: 11

✓ 生成成功: 成功為 2025-11-02 至 2025-11-08 生成 11 筆工作流程記錄

🔄 嘗試重新載入數據 (第 1 次)...
✅ 查詢成功: 載入 11 筆記錄
✅ 數據已更新到界面
更新後記錄數: 11
```

### 刷新時應該看到：

```
🔄 刷新當週工作流程記錄...
院友ID: 19
週期: 2025-11-02 至 2025-11-08
✅ 刷新成功: 載入 11 筆記錄
```

## 預期結果

### ✅ 成功指標

1. **生成成功**
   - 彈出包含記錄數量的成功提示
   - 表格立即顯示所有工作流程按鈕
   - 控制台顯示正確的日誌

2. **界面顯示正確**
   - 每個時間槽顯示三個按鈕（執藥、核藥、派藥）
   - 按鈕狀態正確（藍色=待處理，綠色=已完成，紅色=失敗）
   - 可以正常點擊操作按鈕

3. **數據一致性**
   - 切換院友後數據正確更新
   - 刷新後數據保持一致
   - 操作記錄正確保存

### ❌ 失敗情況處理

如果生成後仍然沒有顯示工作流程按鈕：

1. **檢查控制台錯誤**
   - 查看是否有紅色錯誤訊息
   - 記錄錯誤內容

2. **手動刷新**
   - 點擊"刷新"按鈕
   - 檢查是否成功載入

3. **驗證數據庫**
   - 打開 Supabase Dashboard
   - 檢查 `medication_workflow_records` 表
   - 確認記錄是否已插入

4. **重試生成**
   - 如果重試機制失敗，系統會提示
   - 可以再次點擊生成按鈕

## 邊緣情況測試

### 測試 A: 無在服處方的院友

1. 選擇一個沒有在服處方的院友
2. 點擊生成按鈕
3. 應該提示：`此院友目前無在服處方，無工作流程記錄需要生成`

### 測試 B: 網絡延遲模擬

1. 打開開發者工具 → Network 面板
2. 將網絡速度設為 "Slow 3G"
3. 執行生成操作
4. 系統應該自動重試，最終成功載入

### 測試 C: 部分日期失敗

1. 如果某些日期生成失敗
2. 應該顯示部分成功的訊息
3. 已成功的記錄應該正常顯示

## 性能驗證

### 生成速度

- **舊版本**: 逐日循環載入，約 10-15 秒
- **新版本**: 一次性查詢，約 3-5 秒
- **改進**: 速度提升 50-70%

### 數據準確性

- 驗證生成的記錄數與預期一致
- 驗證所有時間槽都有對應記錄
- 驗證處方和工作流程記錄正確關聯

## 回歸測試

確保其他功能未受影響：

1. **一鍵操作**
   - 一鍵執藥
   - 一鍵核藥
   - 一鍵派藥
   - 一鍵全程

2. **處方管理**
   - 新增處方
   - 編輯處方
   - 停用處方

3. **數據篩選**
   - 備藥方式篩選
   - 日期導航
   - 院友切換

## 問題報告

如果發現問題，請記錄：

1. **問題描述**: 具體發生了什麼
2. **復現步驟**: 如何重現問題
3. **預期結果**: 應該顯示什麼
4. **實際結果**: 實際顯示了什麼
5. **控制台日誌**: 相關的錯誤訊息
6. **瀏覽器版本**: 使用的瀏覽器和版本
7. **截圖**: 如果可能，提供截圖

---

**測試版本**: v1.0
**修復日期**: 2025-11-09
**預計測試時間**: 10-15 分鐘
