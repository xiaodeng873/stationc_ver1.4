# 處方標籤OCR智能識別功能說明

## 功能概述

本系統已成功整合處方標籤OCR（光學字符識別）智能識別功能，可以自動識別處方標籤圖片並將資料填入處方表單，大幅提升資料輸入效率。

## 主要功能

### 1. 智能識別處方標籤
- **圖片上傳**：支援拖放或點擊上傳，接受JPG、PNG、WEBP格式
- **自動壓縮**：自動優化圖片大小，提升處理速度
- **OCR文字識別**：使用Google Cloud Vision API進行高精度文字識別
- **AI智能擷取**：使用Google Gemini AI根據prompt提取結構化資料

### 2. Prompt管理系統
- **預設模板**：提供兩個內建模板
  - **標準處方標籤識別**：適用於完整的處方標籤
  - **簡化版識別**：適用於資訊不完整的標籤
- **自訂Prompt**：用戶可以完全自訂AI識別指令
- **雲端同步**：Prompt設定儲存在Supabase，可跨裝置、跨瀏覽器同步
- **快速切換**：可在不同模板間快速切換

### 3. 自動欄位填入
系統會自動識別並填入以下欄位：
- 院友姓名（自動匹配現有院友）
- 處方日期
- 藥物名稱
- 藥物來源
- 劑型（片劑、膠囊、藥水等）
- 服用途徑（口服、注射、外用等）
- 服用份量和單位
- 服用次數
- 服用日數
- 服用時間（自動解析為陣列格式）
- 需要時（PRN）標記
- 備註

### 4. 信心度視覺標示系統

#### 信心度等級
- **高信心度（≥80%）**：藍色背景，✓ 標記
- **中信心度（50-79%）**：黃色背景，! 標記
- **低信心度（<50%）**：橙色背景，⚠ 標記

#### 視覺提示
- 自動填入的欄位會有淡色背景標示
- 欄位標籤旁顯示星星圖標和信心度標記
- 滑鼠懸停可查看具體信心度百分比

### 5. 手動修正功能
- **完全可編輯**：所有OCR填入的欄位都可以手動修改
- **接受全部**：一鍵移除所有視覺標示，確認資料正確
- **清除OCR結果**：一鍵清空所有自動填入的內容，重新開始
- **重新識別**：保留圖片，修改prompt後重新執行識別

### 6. 識別歷史記錄
- 系統自動記錄每次OCR識別的結果
- 記錄包含：原始文字、擷取資料、使用的prompt、信心度分數
- 可用於追蹤和改進識別準確度

### 7. 智能快取機制
- 相同圖片的識別結果會被快取
- 避免重複處理，提升效率
- 快取基於圖片hash值，確保準確性

## 技術架構

### 後端架構
- **Supabase Edge Functions**：作為API代理，保護Google API金鑰
  - `vision-ocr`：處理Google Cloud Vision API呼叫
  - `gemini-extract`：處理Google Gemini AI呼叫
- **資料庫表**：
  - `ocr_prompt_templates`：系統預設prompt模板
  - `user_ocr_prompts`：用戶自訂prompt
  - `ocr_recognition_logs`：識別歷史記錄

### 前端組件
- **OCRPrescriptionBlock**：獨立的OCR區塊組件
- **ocrProcessor.ts**：OCR處理工具
- **promptManager.ts**：Prompt管理工具
- **ocrFieldMapper.ts**：欄位映射和預填邏輯

## 使用方式

### 基本使用流程

1. **開啟處方模態框**
   - 點擊「新增處方」或「編輯處方」

2. **展開OCR區塊**
   - 點擊頂部的「智能識別處方標籤」區塊

3. **選擇或調整Prompt**
   - 從下拉選單選擇預設模板，或
   - 自訂prompt內容

4. **上傳處方標籤圖片**
   - 拖放圖片到上傳區域，或
   - 點擊上傳區域選擇圖片

5. **開始識別**
   - 點擊「開始識別」按鈕
   - 等待處理完成（通常5-10秒）

6. **檢查結果**
   - 查看自動填入的欄位
   - 注意低信心度標記的欄位
   - 手動修正任何錯誤

7. **確認並儲存**
   - 點擊「接受全部」移除視覺標示（可選）
   - 點擊「新增處方」或「更新處方」儲存

### 進階使用技巧

#### 自訂Prompt
如果預設prompt無法準確識別您的處方標籤，可以：

1. 在prompt輸入框中編輯指令
2. 明確指定需要提取的欄位
3. 提供範例格式
4. 點擊「儲存為預設」保存您的設定

#### Prompt編寫建議
```
你是醫療資料分類的專家...

提取規則：
1. 劑型選項：片劑、膠囊、藥水、注射劑、外用藥膏、滴劑
2. 服用途徑選項：口服、注射、外用、滴眼、滴耳、鼻胃管
3. 日期格式：YYYY-MM-DD
4. 時間格式：24小時制陣列，如["08:00", "14:00"]

返回JSON格式：
{
  "院友姓名": "...",
  "藥物名稱": "...",
  ...
}
```

## 注意事項

### 重要提醒
1. **OCR是輔助工具**：識別結果僅供參考，務必人工檢查確認
2. **低信心度欄位**：特別注意橙色和黃色標示的欄位
3. **院友匹配**：如果系統無法自動匹配院友，需要手動選擇
4. **圖片品質**：清晰的圖片可大幅提升識別準確度
5. **網路連接**：OCR需要網路連接Google API

### 最佳實踐
- 拍攝處方標籤時確保光線充足、文字清晰
- 避免反光和陰影
- 盡量保持圖片水平、無傾斜
- 定期檢查識別歷史，發現常見錯誤並調整prompt
- 如果某類處方標籤經常識別錯誤，可建立專門的prompt模板

## 安全性

- **API金鑰保護**：Google API金鑰完全隱藏在Supabase Edge Functions中
- **RLS安全控制**：所有資料表啟用Row Level Security
- **用戶資料隔離**：每位用戶只能存取自己的prompt和識別記錄
- **認證要求**：所有OCR功能都需要用戶登入

## 效能優化

- **圖片壓縮**：上傳前自動壓縮大圖片
- **結果快取**：相同圖片的識別結果會被快取
- **請求防抖**：避免連續點擊觸發多次API呼叫
- **批次優化**：支援未來的批次處理功能

## 故障排除

### 常見問題

**Q: 為什麼識別失敗？**
A: 可能原因：
- 圖片品質太差
- 文字過於模糊
- 網路連接問題
- API暫時不可用

**Q: 識別結果不準確怎麼辦？**
A: 建議：
- 檢查圖片品質
- 調整prompt指令
- 手動修正錯誤欄位
- 記錄常見錯誤模式

**Q: 可以離線使用嗎？**
A: 不可以。OCR功能需要連接Google API，必須有網路連接。

**Q: 支援哪些圖片格式？**
A: 支援JPG、JPEG、PNG、WEBP格式，建議使用JPG或PNG。

## 未來擴展

計劃中的功能：
- 批次處理多張處方標籤
- 識別準確度統計分析
- 自動學習和改進prompt
- 支援更多語言和格式
- 離線OCR引擎選項

## 技術支援

如有任何問題或建議，請聯繫系統管理員。

---

**版本**：1.0.0
**更新日期**：2025年10月4日
