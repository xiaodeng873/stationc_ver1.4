# 個人藥物記錄功能實作總結

## 已完成的功能

### 1. 核心生成器 (`src/utils/personalMedicationListExcelGenerator.ts`)

#### 主要功能：
- **範本格式提取** (`extractPersonalMedicationListTemplateFormat`)
  - 提取 Excel 範本的 1-9 列（1-8 列表頭 + 第 9 列條目範本）
  - 提取欄寬、列高、合併儲存格、字型、邊框、對齊方式等所有格式
  - 儲存列印設定以便後續應用

- **深層複製機制** (`deepCopyRange`)
  - 完整複製第 9 列的所有格式屬性到新列
  - 確保每個處方條目的樣式完全一致
  - 支援合併儲存格的複製

- **處方排序功能** (`sortPrescriptions`)
  - 按藥物名稱排序（中文排序）
  - 按處方日期排序（由新到舊）
  - 按開始日期排序（由新到舊）
  - 按藥物來源排序

- **數據填充**
  - A 欄：編號（1., 2., 3.）
  - B 欄：藥名（粗體）+ 劑型、劑量、使用次數/時間、使用途徑（逗號分隔）
  - C 欄：需要時用藥標記
  - D 欄：開始使用日期
  - E 欄：停用日期
  - F 欄：藥物來源
  - G 欄：注意事項/備註
  - H 欄：最近修改者

- **院友資料映射**
  - B3：中文姓名
  - C3：英文姓名
  - F3：身份證號碼
  - I3：床號
  - C4：藥物過敏（或 NKDA）
  - C5：藥物不良反應（或 NKADR）

- **智能分頁**
  - 每頁最多 15 項處方條目
  - 超過 15 項自動開新頁
  - 新頁自動複製表頭（1-8 列）
  - 保持頁碼連續性

#### 匯出函數：
1. **`exportPersonalMedicationListToExcel`** - 批量匯出多位院友
2. **`exportSelectedPersonalMedicationListToExcel`** - 匯出選中的處方

### 2. 範本管理整合 (`src/pages/TemplateManagement.tsx`)

#### 已新增：
- 範本類型：`'personal-medication-list'`
- 類型標籤：「個人藥物記錄」
- 類型描述：「院友的個人藥物處方清單」
- 顏色標籤：紫色 (`bg-violet-100 text-violet-800`)
- 格式提取分支：調用 `extractPersonalMedicationListTemplateFormat`

## 範本格式要求

### Excel 範本結構：
```
第 1-8 列：表頭區域
  - B3: 中文姓名
  - C3: 英文姓名
  - F3: 身份證號碼
  - I3: 床號
  - C4: 藥物過敏
  - C5: 藥物不良反應

第 9 列：處方條目範本列
  - A 欄：編號
  - B 欄：藥名及詳細資訊
  - C 欄：需要時
  - D 欄：開始日期
  - E 欄：結束日期
  - F 欄：藥物來源
  - G 欄：注意事項
  - H 欄：電子簽名
```

## 使用方式

### 1. 上傳範本
1. 進入「範本管理」頁面
2. 選擇範本類型為「個人藥物記錄」
3. 上傳符合格式要求的 Excel 範本檔案
4. 系統自動提取並儲存範本格式

### 2. 匯出個人藥物記錄
（待整合到處方管理頁面）
- 選擇院友
- 選擇排序方式（藥物名稱/處方日期/開始日期/藥物來源）
- 點擊匯出按鈕
- 系統生成符合範本格式的 Excel 檔案

## 技術特點

1. **完全參照「個人備藥及給藥記錄」的實作方式**
   - 使用相同的 `@zurmokeeper/exceljs` 庫
   - 採用深層複製機制確保格式一致
   - 支援多工作表處理

2. **靈活的排序功能**
   - 支援 4 種排序方式
   - 中文排序正確處理
   - 日期排序由新到舊

3. **智能分頁**
   - 自動計算頁數
   - 表頭循環使用
   - 格式完整複製

4. **錯誤處理**
   - 範本格式驗證
   - 缺失數據處理
   - 詳細的 console 日誌

## 編譯狀態

✅ TypeScript 編譯無錯誤
✅ Vite 建置成功
✅ 所有依賴項正確導入

## 下一步建議

1. 創建匯出對話框組件（參考 `MedicationRecordExportModal.tsx`）
2. 在處方管理頁面整合匯出按鈕和對話框
3. 實際測試範本上傳和匯出功能
4. 根據實際使用情況調整欄位映射和格式

---

實作日期：2025-11-08
