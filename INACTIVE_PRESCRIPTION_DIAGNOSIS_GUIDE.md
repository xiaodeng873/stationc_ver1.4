# åœç”¨è™•æ–¹å·¥ä½œæµç¨‹è¨˜éŒ„è¨ºæ–·æŒ‡å—

## æ¦‚è¿°

ç•¶æ‚¨ç™¼ç¾å·¥ä½œæµç¨‹è¡¨æ ¼ä¸­é¡¯ç¤ºçš„è™•æ–¹æ˜¯**å·²åœç”¨**çš„è™•æ–¹æ™‚ï¼Œæœ¬æŒ‡å—å°‡å¹«åŠ©æ‚¨ç†è§£é€™æ˜¯å¦‚ä½•é‹ä½œçš„ï¼Œä»¥åŠå¦‚ä½•è¨ºæ–·ç›¸é—œå•é¡Œã€‚

## åœç”¨è™•æ–¹çš„è¨­è¨ˆé‚è¼¯

### ç‚ºä»€éº¼åœç”¨è™•æ–¹ä»æœƒé¡¯ç¤ºï¼Ÿ

ç³»çµ±è¨­è¨ˆä¸Šï¼Œ**åœç”¨è™•æ–¹çš„æ­·å²è¨˜éŒ„æœƒè¢«ä¿ç•™**ä¸¦ç¹¼çºŒåœ¨å·¥ä½œæµç¨‹è¡¨æ ¼ä¸­é¡¯ç¤ºï¼ŒåŸå› åŒ…æ‹¬ï¼š

1. **ç”¨è—¥æ­·å²è¿½è¹¤**ï¼šé†«è­·äººå“¡éœ€è¦æŸ¥çœ‹é™¢å‹éå»çš„ç”¨è—¥æƒ…æ³
2. **ç¨½æ ¸éœ€æ±‚**ï¼šä¿ç•™å®Œæ•´çš„çµ¦è—¥è¨˜éŒ„ç”¨æ–¼æŸ¥æ ¸å’Œè¿½æº¯
3. **æ­·å²æ•¸æ“šå®Œæ•´æ€§**ï¼šåœç”¨è™•æ–¹åœ¨åœç”¨å‰ç”Ÿæˆçš„è¨˜éŒ„ä»ç„¶æœ‰æ•ˆä¸”æ‡‰è©²ä¿ç•™
4. **æ“ä½œé€£çºŒæ€§**ï¼šå¯ä»¥æŸ¥çœ‹åœç”¨å‰å¾Œçš„å®Œæ•´ç”¨è—¥æµç¨‹

### åœç”¨è™•æ–¹çš„é¡¯ç¤ºè¦å‰‡

- âœ… **é¡¯ç¤ºæ¢ä»¶**ï¼šè©²é€±æœŸå…§æœ‰å·¥ä½œæµç¨‹è¨˜éŒ„ï¼ˆåœç”¨å‰ç”Ÿæˆçš„ï¼‰
- âŒ **ä¸é¡¯ç¤ºæ¢ä»¶**ï¼šè©²é€±æœŸå…§å®Œå…¨æ²’æœ‰è¨˜éŒ„
- ğŸ”’ **ç”Ÿæˆè¦å‰‡**ï¼šåœç”¨å¾Œä¸æœƒç”Ÿæˆæ–°çš„å·¥ä½œæµç¨‹è¨˜éŒ„

### å‰ç«¯é¡¯ç¤ºé‚è¼¯ï¼ˆç¨‹å¼ç¢¼ä½ç½®ï¼‰

åœ¨ `src/pages/MedicationWorkflow.tsx` ç¬¬796-838è¡Œï¼š

```typescript
// éæ¿¾è™•æ–¹ï¼šé¡¯ç¤ºåœ¨æœè™•æ–¹ + åœç”¨ä½†åœ¨ç•¶å‘¨æœ‰å·¥ä½œæµç¨‹è¨˜éŒ„çš„è™•æ–¹
const activePrescriptions = useMemo(() => {
  const filtered = prescriptions.filter(p => {
    // ... é™¢å‹IDæª¢æŸ¥ ...

    // å¦‚æœæ˜¯åœ¨æœè™•æ–¹ï¼Œæª¢æŸ¥æ—¥æœŸæœ‰æ•ˆæ€§
    if (p.status === 'active') {
      // ... æ—¥æœŸç¯„åœæª¢æŸ¥ ...
      return true;
    }

    // å¦‚æœæ˜¯åœç”¨è™•æ–¹ï¼Œæª¢æŸ¥ç•¶å‘¨æ˜¯å¦æœ‰ç›¸é—œå·¥ä½œæµç¨‹è¨˜éŒ„
    if (p.status === 'inactive') {
      return weekPrescriptionIds.has(p.id); // â­ é—œéµé‚è¼¯
    }

    return false;
  });

  return filtered;
}, [prescriptions, selectedPatientId, weekDates, weekPrescriptionIds]);
```

**é—œéµé‚è¼¯è§£é‡‹**ï¼š
- `weekPrescriptionIds` æ˜¯ç•¶å‘¨æ‰€æœ‰å·¥ä½œæµç¨‹è¨˜éŒ„æ¶‰åŠçš„è™•æ–¹IDé›†åˆ
- å¦‚æœåœç”¨è™•æ–¹çš„IDåœ¨é€™å€‹é›†åˆä¸­ï¼Œè¡¨ç¤ºè©²é€±æœŸæœ‰å…¶æ­·å²è¨˜éŒ„ï¼Œå°±æœƒé¡¯ç¤ºåœ¨è¡¨æ ¼ä¸­

## è¨ºæ–·åœç”¨è™•æ–¹å•é¡Œ

### ä½¿ç”¨è¨ºæ–·å·¥å…·

1. å°èˆªåˆ°ã€Œè—¥ç‰©å·¥ä½œæµç¨‹ã€é é¢
2. é¸æ“‡æœ‰åœç”¨è™•æ–¹è¨˜éŒ„çš„é™¢å‹
3. é¸æ“‡ç›¸é—œæ—¥æœŸ
4. é»æ“Šã€Œè¨ºæ–·ã€æŒ‰éˆ•
5. æŒ‰ F12 æŸ¥çœ‹å®Œæ•´è¨ºæ–·å ±å‘Š

### è¨ºæ–·å ±å‘Šä¸­çš„åœç”¨è™•æ–¹æ¨™ç¤º

#### ç¬¬1æ­¥ï¼šè™•æ–¹åˆ—è¡¨

```
===== ç¬¬1æ­¥ï¼šæª¢æŸ¥è™•æ–¹ï¼ˆåŒ…å«åœ¨æœå’Œåœç”¨ï¼‰ =====
âœ… æ‰¾åˆ° 2 å€‹åœ¨æœè™•æ–¹
âœ… æ‰¾åˆ° 1 å€‹åœç”¨è™•æ–¹

è™•æ–¹: Ciprofloxacin (ID: xxx-xxx-xxx)
  é™¢å‹ID: 123
  è™•æ–¹ç‹€æ…‹: ğŸ›‘ åœç”¨
  é »ç‡é¡å‹: daily
  æ™‚é–“æ§½: ["08:00", "12:00", "16:00", ...] (7å€‹)
  é–‹å§‹æ—¥æœŸ: 2025-10-01
  çµæŸæ—¥æœŸ: 2025-11-04
  æœŸé–“æœ‰æ•ˆæ€§: âœ… æœ‰æ•ˆ
  âš ï¸ æ³¨æ„: æ­¤ç‚ºåœç”¨è™•æ–¹ï¼Œä½†åœ¨è©²æœŸé–“å¯èƒ½ä»æœ‰å·²ç”Ÿæˆçš„å·¥ä½œæµç¨‹è¨˜éŒ„
```

**è§£è®€**ï¼š
- ç‹€æ…‹æ¨™ç¤ºç‚ºã€ŒğŸ›‘ åœç”¨ã€
- ä»æœƒæª¢æŸ¥æœŸé–“æœ‰æ•ˆæ€§
- ç‰¹åˆ¥æé†’é€™æ˜¯åœç”¨è™•æ–¹

#### ç¬¬2æ­¥ï¼šè¨˜éŒ„çµ±è¨ˆ

```
===== ç¬¬2æ­¥ï¼šæª¢æŸ¥å·¥ä½œæµç¨‹è¨˜éŒ„ =====
âœ… æ‰¾åˆ° 21 ç­†å·¥ä½œæµç¨‹è¨˜éŒ„

æ¯æ—¥è¨˜éŒ„çµ±è¨ˆ:
  2025-11-02: 7 ç­†, 1 å€‹è™•æ–¹
  2025-11-03: 7 ç­†, 1 å€‹è™•æ–¹
  2025-11-04: 7 ç­†, 1 å€‹è™•æ–¹
  2025-11-05: 0 ç­† âš ï¸
  ...
```

**è§£è®€**ï¼š
- å‰3å¤©æœ‰è¨˜éŒ„ï¼ˆåœç”¨å‰ç”Ÿæˆçš„ï¼‰
- å¾Œé¢çš„æ—¥æœŸæ²’æœ‰è¨˜éŒ„ï¼ˆåœç”¨å¾Œä¸å†ç”Ÿæˆï¼‰

#### ç¬¬4æ­¥ï¼šé æœŸvså¯¦éš›

```
===== ç¬¬4æ­¥ï¼šè¨ˆç®—é æœŸè¨˜éŒ„æ•¸ =====

è™•æ–¹ Ciprofloxacin (åœç”¨):
  é æœŸ: 21 ç­†, å¯¦éš›: 21 ç­† âœ…

è™•æ–¹ å…¶ä»–è—¥ç‰© (åœ¨æœ):
  é æœŸ: 14 ç­†, å¯¦éš›: 14 ç­† âœ…

ç¸½è¨ˆ:
  é æœŸç¸½è¨˜éŒ„æ•¸: 35 (åƒ…è¨ˆç®—åœ¨æœè™•æ–¹åŠæœŸé–“å…§æœ‰æ•ˆçš„åœç”¨è™•æ–¹)
  å¯¦éš›ç¸½è¨˜éŒ„æ•¸: 35
  åŒ¹é…ç‹€æ…‹: âœ… å®Œå…¨åŒ¹é…

è™•æ–¹æ‘˜è¦:
  åœ¨æœè™•æ–¹: 2 å€‹
  åœç”¨è™•æ–¹: 1 å€‹
```

**è§£è®€**ï¼š
- åœç”¨è™•æ–¹æœƒæ¨™ç¤ºã€Œ(åœç”¨)ã€
- å¦‚æœåœç”¨è™•æ–¹åœ¨å…¶æœ‰æ•ˆæœŸå…§æœ‰è¨˜éŒ„ï¼Œæœƒè¨ˆå…¥é æœŸæ•¸
- ç¸½çµæœƒæ˜ç¢ºé¡¯ç¤ºåœ¨æœå’Œåœç”¨è™•æ–¹çš„æ•¸é‡

## å¸¸è¦‹å ´æ™¯åˆ†æ

### å ´æ™¯1ï¼šåœç”¨è™•æ–¹é¡¯ç¤ºå®Œæ•´è¨˜éŒ„

**æƒ…æ³æè¿°**ï¼š
- è™•æ–¹åœ¨11æœˆ4æ—¥åœç”¨
- 11æœˆ2-4æ—¥æœ‰å®Œæ•´çš„å·¥ä½œæµç¨‹è¨˜éŒ„
- è¡¨æ ¼ä¸­è©²è™•æ–¹é¡¯ç¤º3å¤©çš„è¨˜éŒ„æ ¼å­

**è¨ºæ–·çµæœ**ï¼š
```
è™•æ–¹ è—¥ç‰©åç¨± (åœç”¨):
  é æœŸ: 21 ç­† (3å¤© x 7æ¬¡), å¯¦éš›: 21 ç­† âœ…
```

**çµè«–**ï¼šâœ… æ­£å¸¸ï¼Œé€™æ˜¯åœç”¨å‰ç”Ÿæˆçš„æ­·å²è¨˜éŒ„

---

### å ´æ™¯2ï¼šåœç”¨è™•æ–¹ç¼ºå°‘è¨˜éŒ„

**æƒ…æ³æè¿°**ï¼š
- è™•æ–¹åœ¨11æœˆ4æ—¥åœç”¨
- æ‡‰è©²æœ‰11æœˆ2-4æ—¥çš„è¨˜éŒ„ï¼ˆ21ç­†ï¼‰
- ä½†åªæœ‰14ç­†è¨˜éŒ„

**è¨ºæ–·çµæœ**ï¼š
```
è™•æ–¹ è—¥ç‰©åç¨± (åœç”¨):
  é æœŸ: 21 ç­†, å¯¦éš›: 14 ç­† âŒ

æ¯æ—¥è¨˜éŒ„çµ±è¨ˆ:
  2025-11-02: 7 ç­†
  2025-11-03: 7 ç­†
  2025-11-04: 0 ç­† âš ï¸
```

**çµè«–**ï¼šâŒ ä¸æ­£å¸¸ï¼Œåœç”¨å‰çš„è¨˜éŒ„æœªå®Œæ•´ç”Ÿæˆ

**è§£æ±ºæ–¹æ³•**ï¼š
1. é€™äº›è¨˜éŒ„æ‡‰è©²åœ¨è™•æ–¹åœç”¨å‰å°±ç”Ÿæˆ
2. ç„¡æ³•ç‚ºå·²åœç”¨çš„è™•æ–¹è£œç”Ÿæˆè¨˜éŒ„
3. å»ºè­°æŸ¥è©¢æ˜¯å¦æœ‰äººå·¥åˆªé™¤è¨˜éŒ„ï¼Œæˆ–æª¢æŸ¥åœç”¨æ™‚é–“é»

---

### å ´æ™¯3ï¼šåªæœ‰åœç”¨è™•æ–¹é¡¯ç¤º

**æƒ…æ³æè¿°**ï¼š
- é™¢å‹ç›®å‰æ²’æœ‰åœ¨æœè™•æ–¹
- ä½†è©²é€±æœŸå…§æœ‰åœç”¨è™•æ–¹çš„æ­·å²è¨˜éŒ„
- è¡¨æ ¼åªé¡¯ç¤ºåœç”¨è™•æ–¹çš„è¨˜éŒ„æ ¼å­

**è¨ºæ–·çµæœ**ï¼š
```
âœ… æ‰¾åˆ° 0 å€‹åœ¨æœè™•æ–¹
âœ… æ‰¾åˆ° 1 å€‹åœç”¨è™•æ–¹

ç¸½è¨ˆ:
  é æœŸç¸½è¨˜éŒ„æ•¸: 21
  å¯¦éš›ç¸½è¨˜éŒ„æ•¸: 21
  åŒ¹é…ç‹€æ…‹: âœ… å®Œå…¨åŒ¹é…

è™•æ–¹æ‘˜è¦:
  åœ¨æœè™•æ–¹: 0 å€‹
  åœç”¨è™•æ–¹: 1 å€‹
```

**çµè«–**ï¼šâœ… æ­£å¸¸ï¼Œé™¢å‹ç•¶å‰ç„¡åœ¨æœè™•æ–¹ï¼Œåƒ…é¡¯ç¤ºæ­·å²è¨˜éŒ„

---

### å ´æ™¯4ï¼šè¨˜éŒ„æ•¸å¤šæ–¼é æœŸ

**æƒ…æ³æè¿°**ï¼š
- æœ‰2å€‹åœ¨æœè™•æ–¹ï¼ˆé æœŸ28ç­†è¨˜éŒ„ï¼‰
- æœ‰1å€‹åœç”¨è™•æ–¹ï¼ˆåœ¨é€±æœŸå…§æœ‰21ç­†æ­·å²è¨˜éŒ„ï¼‰
- å¯¦éš›è¨˜éŒ„æ•¸ï¼š49ç­†

**è¨ºæ–·çµæœ**ï¼š
```
è™•æ–¹ è—¥ç‰©A (åœ¨æœ):
  é æœŸ: 14 ç­†, å¯¦éš›: 14 ç­† âœ…

è™•æ–¹ è—¥ç‰©B (åœ¨æœ):
  é æœŸ: 14 ç­†, å¯¦éš›: 14 ç­† âœ…

è™•æ–¹ è—¥ç‰©C (åœç”¨):
  é æœŸ: 0 ç­†, å¯¦éš›: 21 ç­† âŒ
  â„¹ï¸ èªªæ˜: æ­¤åœç”¨è™•æ–¹åœ¨æŸ¥è©¢æœŸé–“ä¸æ‡‰æœ‰æ–°è¨˜éŒ„ï¼Œä½†æœ‰21ç­†å·²å­˜åœ¨çš„è¨˜éŒ„ï¼ˆå¯èƒ½æ˜¯åœç”¨å‰ç”Ÿæˆçš„ï¼‰

ç¸½è¨ˆ:
  é æœŸç¸½è¨˜éŒ„æ•¸: 28 (åƒ…è¨ˆç®—åœ¨æœè™•æ–¹)
  å¯¦éš›ç¸½è¨˜éŒ„æ•¸: 49
  åŒ¹é…ç‹€æ…‹: âš ï¸ è¨˜éŒ„æ•¸å¤šæ–¼é æœŸ
  â„¹ï¸ å¯èƒ½åŸå› : åŒ…å«åœç”¨è™•æ–¹åœ¨åœç”¨å‰ç”Ÿæˆçš„è¨˜éŒ„
```

**çµè«–**ï¼šâœ… æ­£å¸¸ï¼Œå¯¦éš›è¨˜éŒ„åŒ…å«äº†åœç”¨è™•æ–¹çš„æ­·å²è¨˜éŒ„

---

## å¦‚ä½•å€åˆ†åœç”¨è™•æ–¹

### åœ¨è¡¨æ ¼ä¸­

ç›®å‰è¡¨æ ¼**ä¸æœƒ**ç‰¹åˆ¥æ¨™ç¤ºè™•æ–¹æ˜¯å¦åœç”¨ï¼Œå› ç‚ºï¼š
- åœç”¨è™•æ–¹åªé¡¯ç¤ºæ­·å²è¨˜éŒ„ï¼ˆåœç”¨å‰ç”Ÿæˆçš„ï¼‰
- ä¸æœƒç”Ÿæˆæ–°çš„è¨˜éŒ„
- é€šå¸¸å¾ˆå¿«å°±æœƒå¾ç•¶å‘¨è¦–åœ–ä¸­æ¶ˆå¤±ï¼ˆç•¶é€±æœŸè¶…å‡ºæœ‰æ•ˆæœŸï¼‰

### åœ¨è¨ºæ–·å ±å‘Šä¸­

åœç”¨è™•æ–¹æœƒæ˜ç¢ºæ¨™ç¤ºï¼š
- ç¬¬1æ­¥ï¼šã€Œè™•æ–¹ç‹€æ…‹: ğŸ›‘ åœç”¨ã€
- ç¬¬4æ­¥ï¼šã€Œè™•æ–¹ è—¥ç‰©åç¨± (åœç”¨)ã€
- ç¸½çµï¼šã€Œè™•æ–¹æ‘˜è¦: åœç”¨è™•æ–¹: X å€‹ã€

### åœ¨è™•æ–¹ç®¡ç†é é¢

å¯ä»¥åˆ°ã€Œè™•æ–¹ç®¡ç†ã€é é¢æŸ¥çœ‹è™•æ–¹çš„å®Œæ•´ç‹€æ…‹ï¼š
- ç‹€æ…‹æ¬„æœƒé¡¯ç¤ºã€Œåœç”¨ã€
- å¯ä»¥æŸ¥çœ‹åœç”¨æ—¥æœŸï¼ˆend_dateï¼‰
- å¯ä»¥æŸ¥çœ‹å®Œæ•´çš„è™•æ–¹æ­·å²

## æŠ€è¡“ç´°ç¯€

### åœç”¨è™•æ–¹çš„æ•¸æ“šåº«æŸ¥è©¢

è¨ºæ–·å·¥å…·æœƒåˆ†åˆ¥æŸ¥è©¢åœ¨æœå’Œåœç”¨è™•æ–¹ï¼š

```typescript
// æŸ¥è©¢åœ¨æœè™•æ–¹
const { data: activePrescriptions } = await supabase
  .from('new_medication_prescriptions')
  .select('*')
  .eq('status', 'active')
  .lte('start_date', endDate);

// æŸ¥è©¢åœç”¨è™•æ–¹
const { data: inactivePrescriptions } = await supabase
  .from('new_medication_prescriptions')
  .select('*')
  .eq('status', 'inactive');

// åˆä½µè™•æ–¹åˆ—è¡¨
const prescriptions = [...activePrescriptions, ...inactivePrescriptions];
```

### é æœŸè¨˜éŒ„æ•¸çš„è¨ˆç®—é‚è¼¯

å°æ–¼åœç”¨è™•æ–¹ï¼š
1. æª¢æŸ¥è™•æ–¹çš„æœ‰æ•ˆæœŸæ˜¯å¦èˆ‡æŸ¥è©¢æœŸé–“æœ‰äº¤é›†
2. å¦‚æœæœ‰äº¤é›†ï¼Œè¨ˆç®—åœ¨æœ‰æ•ˆæœŸå…§æ‡‰è©²æœ‰çš„è¨˜éŒ„æ•¸
3. å¦‚æœæ²’æœ‰äº¤é›†ï¼Œé æœŸè¨˜éŒ„æ•¸ç‚º0ï¼ˆä½†å¯èƒ½ä»æœ‰å¯¦éš›è¨˜éŒ„ï¼‰

```typescript
// æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨è™•æ–¹æœ‰æ•ˆæœŸå…§
if (currentDate >= start && (!end || currentDate <= end)) {
  // æª¢æŸ¥æ˜¯å¦æ ¹æ“šé »ç‡è¦å‰‡éœ€è¦æœè—¥
  if (shouldTakeMedicationOnDate(p, currentDate)) {
    const timeSlots = p.medication_time_slots?.length || 0;
    prescExpected += timeSlots;
  }
}
```

## ç¸½çµ

âœ… **æ­£å¸¸æƒ…æ³**ï¼š
- åœç”¨è™•æ–¹åœ¨å…¶æœ‰æ•ˆæœŸå…§çš„æ­·å²è¨˜éŒ„æœƒç¹¼çºŒé¡¯ç¤º
- è¨ºæ–·å ±å‘Šæœƒæ¸…æ¥šæ¨™ç¤ºåœç”¨è™•æ–¹
- å¯¦éš›è¨˜éŒ„æ•¸å¯èƒ½å¤§æ–¼é æœŸï¼ˆåŒ…å«åœç”¨è™•æ–¹çš„æ­·å²è¨˜éŒ„ï¼‰

âŒ **éœ€è¦æ³¨æ„çš„æƒ…æ³**ï¼š
- åœç”¨è™•æ–¹åœ¨åœç”¨å‰æ‡‰è©²æœ‰çš„è¨˜éŒ„ç¼ºå¤±
- ç„¡æ³•åˆ¤æ–·è™•æ–¹æ˜¯åœ¨æœé‚„æ˜¯åœç”¨ï¼ˆå‰ç«¯é¡¯ç¤ºé‚è¼¯å•é¡Œï¼‰

ğŸ”§ **è¨ºæ–·å·¥å…·çš„å„ªå‹¢**ï¼š
- æ˜ç¢ºå€åˆ†åœ¨æœå’Œåœç”¨è™•æ–¹
- åˆ†åˆ¥çµ±è¨ˆå„é¡è™•æ–¹çš„è¨˜éŒ„æ•¸
- æä¾›è©³ç´°çš„èªªæ˜å’Œå»ºè­°

---

**ç›¸é—œæ–‡æª”**ï¼š
- `WORKFLOW_DISPLAY_DIAGNOSTIC_GUIDE.md` - å®Œæ•´è¨ºæ–·æŒ‡å—
- `WORKFLOW_FIX_QUICK_TEST.md` - å¿«é€Ÿæ¸¬è©¦æŒ‡å—
