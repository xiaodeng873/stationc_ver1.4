# 工作流程顯示問題修復 - 快速測試指南

## 修復內容摘要

針對「11月2-8日週期內處方顯示但21筆工作流程記錄未顯示」的問題，本次更新包含：

1. ✅ 新增診斷工具：一鍵分析數據完整性和顯示問題
2. ✅ 增強調試日誌：自動記錄週期計算和記錄載入詳情
3. ✅ 優化記錄查詢：確保正確載入指定週期的所有記錄
4. ✅ 完善頻率判斷：與 Edge Function 邏輯保持一致

## 快速測試步驟（3分鐘）

### 步驟1：導航到工作流程頁面（30秒）

1. 登入系統
2. 點擊左側菜單的「藥物工作流程」
3. 選擇一個有在服處方的院友

### 步驟2：選擇問題日期範圍（30秒）

1. 在日期選擇器中選擇 **2025-11-05**（11月2-8日週期內的任意日期）
2. 系統會自動計算並顯示整個週期（11月2日～11月8日）

### 步驟3：執行診斷（1分鐘）

1. 按 **F12** 打開瀏覽器控制台（Console標籤）
2. 點擊頁面右上角的 **「診斷」** 按鈕
3. 等待診斷完成（約5-10秒）
4. 查看彈出的診斷摘要對話框
5. 在控制台中查看詳細診斷報告

### 步驟4：驗證診斷結果（1分鐘）

在控制台中檢查以下關鍵信息：

#### ✅ 檢查項目1：週期計算
```
📅 週期計算: 輸入日期 2025-11-05 (星期三)
   週日起始: 2025-11-02
   週期範圍: 2025-11-02 ~ 2025-11-08
```
**預期結果**：週期應正確涵蓋11月2日～11月8日（共7天）

#### ✅ 檢查項目2：記錄載入
```
✅ 成功載入當周記錄: X 筆
📊 按日期分布:
  2025-11-02: X 筆
  2025-11-03: X 筆
  ...
  2025-11-08: X 筆
```
**預期結果**：如果有每日7次服藥的處方，應顯示每日7筆記錄

#### ✅ 檢查項目3：頻率判斷
```
處方: [藥物名稱]
  各日期服藥判斷:
    2025-11-02: ✅ 需要服藥
    2025-11-03: ✅ 需要服藥
    ...
    2025-11-08: ✅ 需要服藥
```
**預期結果**：如果是每日服藥的處方，所有7天都應顯示「✅ 需要服藥」

#### ✅ 檢查項目4：記錄匹配
```
總計:
  預期總記錄數: 21
  實際總記錄數: 21
  匹配狀態: ✅ 完全匹配
```
**預期結果**：預期數與實際數應相等

## 常見測試場景

### 場景A：首次測試（記錄未生成）

**症狀**：診斷顯示「實際總記錄數: 0」

**修復步驟**：
1. 點擊「生成本週工作流程」按鈕
2. 等待生成完成（約5-15秒）
3. 點擊「刷新」按鈕
4. 重新執行診斷驗證

### 場景B：數據不同步

**症狀**：診斷顯示「本地記錄: 0 筆，數據庫記錄: 21 筆」

**修復步驟**：
1. 點擊「刷新」按鈕
2. 重新執行診斷驗證

### 場景C：頻率設定問題

**症狀**：診斷顯示某些日期「❌ 不需服藥」

**修復步驟**：
1. 導航到「處方管理」頁面
2. 檢查並修正處方的頻率設定
3. 返回工作流程頁面
4. 重新生成工作流程

## 驗證成功標準

✅ **完全成功**：滿足以下所有條件

1. 週期計算正確涵蓋11月2-8日
2. 表格顯示7列日期（週日～週六）
3. 每個處方在每天的每個時間點都有對應的工作流程記錄格子
4. 診斷報告顯示「✅ 完全匹配」
5. 所有應該服藥的日期都顯示「✅ 需要服藥」

## 問題回報

如果測試中發現問題，請記錄以下信息：

1. 診斷報告的完整截圖或文字複製
2. 控制台中的錯誤信息（如有）
3. 具體的測試場景描述
4. 處方的詳細設定（頻率類型、時間槽等）

## 技術細節

### 新增的診斷函數

**位置**：`src/utils/diagnoseTool.ts`

**功能**：`diagnoseWorkflowDisplayIssue(patientId, startDate, endDate)`

**返回值**：
```typescript
{
  prescriptions: Array,      // 處方列表
  records: Array,           // 工作流程記錄列表
  expectedTotal: number,    // 預期記錄總數
  actualTotal: number,      // 實際記錄總數
  isMatched: boolean        // 是否匹配
}
```

### 增強的日誌輸出

所有關鍵操作都會在控制台輸出詳細日誌：

- 📅 週期計算日誌
- 🔄 記錄載入日誌
- 📊 按日期分布統計
- 🔍 診斷分析報告

## 相關文檔

- **詳細診斷指南**：`WORKFLOW_DISPLAY_DIAGNOSTIC_GUIDE.md`
- **問題修復歷史**：`WORKFLOW_DISPLAY_FIX.md`（如果存在）

---

**預計測試時間**：3-5分鐘
**複雜度**：低
**需要的技能**：基本的瀏覽器操作 + F12控制台查看能力
