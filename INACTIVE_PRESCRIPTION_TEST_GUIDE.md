# 停用處方顯示功能測試指南

## 快速測試步驟

### 測試案例：院友許渠蘭的 Ciprofloxacin 處方

**測試數據：**
- 院友：許渠蘭（院友ID: 19）
- 處方：Ciprofloxacin 500mg
- 處方狀態：停用（inactive）
- 有效期：2025年11月2日 至 2025年11月8日
- 服藥時間：每日 3 次（08:00, 14:00, 20:00）
- 工作流程記錄：20 筆

### 步驟1：驗證停用處方顯示

1. 登入系統
2. 進入「藥物工作流程」頁面
3. 選擇院友「許渠蘭」
4. 選擇週期「2025年11月2日 - 2025年11月8日」

**預期結果：**
- ✅ 應該看到 Ciprofloxacin 500mg 處方顯示在表格中
- ✅ 每天應該有 3 個時間點（08:00, 14:00, 20:00）
- ✅ 應該顯示執藥、核藥、派藥的狀態（已完成/失敗/待處理）
- ✅ 可以點擊格子查看詳細資訊

### 步驟2：檢查瀏覽器控制台日誌

按 F12 開啟開發者工具，查看控制台日誌：

**應該看到的日誌：**
```
🔍 開始過濾處方 (院友ID: 19, 週期: 2025-11-02 ~ 2025-11-08)
  ✅ Ciprofloxacin 500mg (inactive): 停用處方但當周有工作流程記錄，顯示歷史記錄
🔍 過濾結果: X 個處方通過
```

**不應該看到的日誌：**
```
❌ Ciprofloxacin 500mg (inactive): 狀態不是 active，跳過
```

### 步驟3：測試一鍵操作不影響停用處方

1. 在同一頁面，點擊「一鍵執藥」或「一鍵核藥」按鈕
2. 確認操作完成後

**預期結果：**
- ✅ 只有在服處方受到影響
- ✅ Ciprofloxacin（停用處方）的記錄狀態不變
- ✅ 控制台日誌顯示：「當天工作流程記錄: X 筆 (過濾後只包含在服處方)」

### 步驟4：測試週期超出有效期

1. 切換週期到「2025年11月9日 - 2025年11月15日」
2. 查看處方列表

**預期結果：**
- ✅ Ciprofloxacin 處方不顯示（因為該週期無工作流程記錄）
- ✅ 控制台日誌顯示：「Ciprofloxacin 500mg (inactive): 停用處方且當周無記錄，跳過」

### 步驟5：測試記錄編輯功能

1. 回到「2025年11月2日 - 2025年11月8日」週期
2. 點擊 Ciprofloxacin 的某個格子
3. 嘗試撤銷或修改狀態

**預期結果：**
- ✅ 可以正常撤銷已完成的操作
- ✅ 可以查看和修改失敗原因
- ✅ 記錄的修改會保存到資料庫

## 如果測試失敗

### 症狀1：停用處方完全不顯示

**可能原因：**
- 前端代碼未正確部署
- 瀏覽器快取未清除

**解決方法：**
1. 清除瀏覽器快取（Ctrl+Shift+Delete）
2. 強制重新載入頁面（Ctrl+Shift+R）
3. 檢查網路面板確認載入的是最新的 JS 檔案

### 症狀2：一鍵操作影響了停用處方

**可能原因：**
- `currentDayWorkflowRecords` 過濾邏輯有誤

**解決方法：**
1. 檢查控制台日誌中的「當天工作流程記錄」數量
2. 確認只包含在服處方的記錄
3. 如果包含停用處方，檢查第816-855行的過濾邏輯

### 症狀3：控制台出現錯誤

**可能原因：**
- 處方數據結構異常
- weekPrescriptionIds 未正確初始化

**解決方法：**
1. 檢查完整的錯誤堆疊
2. 確認 prescriptions 和 allWorkflowRecords 數據完整
3. 使用診斷工具檢查資料庫數據

## 使用診斷工具

如果需要更詳細的診斷，可以在控制台執行：

```javascript
// 在瀏覽器控制台執行（假設診斷工具已匯出）
diagnoseWorkflowDisplayIssue(19, '2025-11-02', '2025-11-08');
```

這會輸出詳細的診斷報告，包括：
- 所有處方（包含在服和停用）
- 工作流程記錄統計
- 預期記錄數 vs 實際記錄數
- 每日記錄分布
- 處方與記錄的匹配關係

## 驗證清單

使用以下清單確保所有功能正常：

- [ ] 停用處方在有記錄的週期中顯示
- [ ] 停用處方在無記錄的週期中不顯示
- [ ] 在服處方的顯示和操作不受影響
- [ ] 一鍵操作只影響在服處方
- [ ] 可以查看停用處方的記錄詳情
- [ ] 可以編輯和撤銷停用處方的記錄
- [ ] 控制台日誌正確標記停用處方
- [ ] 匯出功能包含停用處方的數據
- [ ] 頁面載入速度正常
- [ ] 無 JavaScript 錯誤

## 測試完成標準

✅ **通過標準：**
- 所有上述步驟的預期結果都符合
- 控制台無錯誤或警告
- 功能符合 `INACTIVE_PRESCRIPTION_WORKFLOW_FIX.md` 的描述
- 與現有功能完全兼容

❌ **失敗標準：**
- 任何步驟的實際結果與預期不符
- 控制台出現與停用處方相關的錯誤
- 影響了在服處方的正常功能
- 一鍵操作影響了停用處方

---

**測試環境建議：**
- Chrome/Edge 最新版本
- 網路連線穩定
- 已清除快取
- 有完整的測試數據

**預計測試時間：** 10-15 分鐘
**測試人員要求：** 熟悉藥物工作流程操作的用戶
